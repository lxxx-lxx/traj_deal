# 轨迹数据处理流水线说明文档

## 项目概述

本项目实现了一套三阶段的轨迹数据处理流水线。  
该流水线用于处理以 JSON 格式存储的多车辆轨迹数据。  
每一个阶段都执行明确且独立的处理任务。  
前一阶段的输出作为后一阶段的输入。  

整个流程的入口脚本为 `run_pipeline.py`。  
所有核心算法和数据处理逻辑均封装在 `pipeline_lib.py` 中。  

---
## 目录结构

```plain text
project/
├── run_pipeline.py  # 主脚本，用于调度完整处理流程
├── pipeline_lib.py  # 函数库，包含全部核心处理逻辑
├── data/            # 原始轨迹 JSON 文件目录
│   └── outputs/     # 第一阶段输出目录
├── data_deal/     # 第二阶段输出目录
└── num/             # 最终筛选结果目录
```

---

## 输入数据格式

每个输入文件为一个 JSON 对象。  
JSON 的键表示车辆编号。  
JSON 的值表示该车辆的轨迹帧序列。  

单个轨迹帧的结构如下：

```
[
position, // [x, y]，车辆在平面坐标系中的位置
direction, // [dx, dy]，车辆行驶方向向量
timestamp // 时间戳
]
```


在处理开始前，各车辆轨迹相互独立。  

---

## 处理流程说明

### 第一阶段：轨迹组合与空间冲突过滤

**对应函数：** `stage1_generate_combinations`  

**输入目录：** `./data`  
**输出目录：** `./data/outputs`  

#### 处理目标

- 对多个原始轨迹文件进行组合，构造新的多车场景。
- 在同一时间戳下检测车辆之间的空间冲突。
- 使用有向包围盒（OBB）方法剔除发生碰撞的车辆。

#### 主要步骤

1. 读取所有文件名以六位数字开头的 JSON 文件。
2. 按文件中轨迹数量对文件进行排序。
3. 将文件划分为固定数量的组。
4. 从每一组中选取指定数量的文件并生成组合。
5. 合并组合内所有车辆轨迹。
6. 构建时间戳到车辆集合的映射关系。
7. 在每个时间戳下进行 OBB 碰撞检测。
8. 当发生碰撞时，保留轨迹长度较长的车辆。
9. 对剩余车辆重新编号。
10. 将结果保存为新的 JSON 文件。

#### 输出结果

- 每个文件组合生成一个新的 JSON 文件。
- 输出文件统一存放在 `data/outputs` 目录中。

---

### 第二阶段：基于主体车的时间裁剪

**对应函数：** `stage2_subject_filter`  

**输入目录：** `./data/outputs`  
**输出目录：** `./data_deal_1`  

#### 处理目标

- 以单辆车作为主体车构造子场景。
- 保证所有保留车辆在时间上完整覆盖主体车轨迹。

#### 主要步骤

1. 读取第一阶段生成的组合场景文件。
2. 计算每辆车的最小和最大时间戳。
3. 依次将每辆车作为主体车进行处理。
4. 保留时间范围完全覆盖主体车的其他车辆。
5. 检查保留车辆数量是否满足最小要求。
6. 检查主体车的时间跨度是否满足最小要求。
7. 将主体车编号固定为 `0`。
8. 对其余车辆进行重新编号。
9. 保存满足条件的子场景文件。

#### 输出结果

- 每个主体车对应一个或多个子场景文件。
- 文件按组合名称分类存放。
- 文件名格式为：`<时间长度>_<车辆数量>.json`。

---

### 第三阶段：最终场景筛选与汇总

**对应函数：** `stage3_collect`  

**输入目录：** `./data_deal_1`  
**输出目录：** `./num`  

#### 处理目标

- 从第二阶段结果中筛选高质量场景。
- 将满足条件的场景集中保存。

#### 主要步骤

1. 递归遍历第二阶段输出目录及其子目录。
2. 从文件名中解析主体车时长和车辆数量。
3. 根据设定阈值进行筛选。
4. 将符合条件的文件复制到最终目录。
5. 使用父目录名作为前缀避免文件重名。

#### 输出结果

- 所有满足条件的场景文件统一存放在 `num` 目录中。

---

## 参数配置说明

所有参数均在 `run_pipeline.py` 中集中配置。

### 第一阶段参数

- `GROUP_NUM`：文件分组数量  
- `PICK_PER_GROUP`：每组选择的文件数量  
- `CAR_LENGTH`：车辆长度（米）  
- `CAR_WIDTH`：车辆宽度（米）  

### 第二阶段参数

- `MIN_VEHICLE_NUM`：最少保留车辆数量  
- `MIN_DURATION_STAGE2`：主体车最小时间跨度  

### 第三阶段参数

- `MIN_DURATION_STAGE3`：最终筛选的最小主体车时长  
- `MIN_TRAJ_NUM`：最终筛选的最小轨迹数量  

---

## 运行方式

在项目根目录下执行：

```
python run_pipeline.py
```

脚本将按顺序自动执行三个处理阶段。  
所有中间结果和最终结果都会写入对应目录。  

---

## 设计说明

- 各阶段在逻辑上相互独立。
- 各阶段在数据上严格串联。
- 主脚本仅负责参数管理和流程控制。
- 所有算法细节均封装在函数库中。

---

## 适用场景

该流水线适用于以下任务：

- 多车辆交互轨迹数据构建  
- 自动驾驶场景生成  
- 场景级数据筛选与清洗  
- 仿真或模型训练前的数据预处理  

